<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-document.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-collection.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<dom-module id="kuestions-question">
  <template>
    <style>
    paper-card {
      display: block;
    }
    paper-card .card-actions {
      padding: 16px;
    }
    paper-radio-group > paper-radio-button {
      display: block;
      padding-left: 24px;
    }
    .nav-section{
      text-align: right;
      padding: 16px 10px;
    }
    </style>
    <p>[[chronoTime]]</p>
    <paper-card hidden$="[[!hideQuestion]]">
      <p>loading question ....</p>
    </paper-card>
    <paper-card hidden$="[[hideQuestion]]" heading="[[question.question]]">
      <div class="horizontal-section">
        <div class="card-content" hidden$="[[hideCodeExample]]">
          <pre><code>[[question.codeExample]]</code></pre>
        </div>
        <paper-radio-group selected="{{selected}}">
          <template is="dom-repeat" items="[[answers]]" as="answer">
            <paper-radio-button name="[[answer.__firebaseKey__]]">[[answer.text]]</paper-radio-button>
          </template>
        </paper-radio-group>
      </div>
      <div class="horizontal-section nav-section">
        <paper-button id="next" hidden$="[[!answered]]" raised>Siguiente</paper-button>
      </div>
    </paper-card>
    <firebase-document
      id="fb"
      location="[[location]]"
      data="{{data}}"></firebase-document>
    <firebase-collection
      log
      location="[[answerLocation]]"
      data="{{answers}}"></firebase-collection>
  </template>
</dom-module>

<script>
  (function() {
    window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
  })();
  Polymer({
    is: 'kuestions-question',

    properties: {
      location: String,
      selected: {
        type: String,
        notify: true,
        observer: '_answerSelected'
      },
      hideQuestion: {
        type: Boolean,
        value: true
      },
      hideCodeExample: {
        type: Boolean,
        value: true
      },
      question: Object,
      countDown: {
        type: Number,
        value: 3
      },
      answered:{
        type: Boolean,
        value: false
      },
      loading: function(){debugger;
        console.log('its being called, mkay');
        return !(foo == bar);
      }
    },
    observers: [
      '_dataReceived(data)'
    ],
    listeners: {
      'next.click': 'goNext'
    },
    ready: function(){
      this.chronoTime = 'Loading...';
    },
    _answerSelected: function(){
      if(this.selected !== null) {
        this.answered=true;
        // TODO: Send answer to server.
        console.log('Answer: %s', this.selected);
      }
    },
    _dataReceived: function(data) {
      if(data) {
        this.chronoTime=0;
        var fbKey = Object.keys(data)[0];
        this.question = data[fbKey];
        this.answerLocation = this.location + fbKey + '/answers/';
        this.hideCodeExample = !this.question.codeExample;
        if(!this.question.start) {
          this.chronoTime = this.countDown;
          this.intervalId = setInterval(this._questionReady.bind(this), 1000);
        }
      }
    },
    _questionReady: function(){
      this.countDown--;
      if(this.countDown > 0) {
        this.chronoTime = this.countDown.toString();
      } else if (this.countDown === 0) {
        this.chronoTime = 'Go!';
      } else {
        clearInterval(this.intervalId);
        this.hideQuestion = false;
        this.start = new Date();
        //this.$.fb.set('data.0.start', this.start);
        requestAnimationFrame(this.chrono.bind(this));
      }
    },
    goNext:function(){
      this.hideQuestion=true;
debugger;
      //TODO call to next question


    },
    chrono: function(){
      this.end = new Date();
      this.time = new Date(this.end - this.start);
      this.chronoTime = this.time.getSeconds() + '.' + this.time.getMilliseconds();
      if(this.selected === null) {
        requestAnimationFrame(this.chrono.bind(this));
      }
    }
  });
</script>
